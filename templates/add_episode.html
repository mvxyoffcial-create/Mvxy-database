<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Episode</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: auto; background: #282c34; color: #fff;}
        h1 { text-align: center; color: #fff;}
        form div { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; color: #fff;}
        input[type="text"], input[type="number"], textarea { width: 100%; padding: 8px; box-sizing: border-box; background: #4a505b; border: 1px solid #555; color: #fff; border-radius: 5px;}
        textarea { height: 100px; }
        .button-group { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;}
        button { padding: 10px 15px; cursor: pointer; background: #6a11cb; color: #fff; border: none; border-radius: 5px; font-size: 16px;}
        button:hover { background: #2575fc; }
        a {
            display: inline-block;
            padding: 10px 15px;
            background: #555;
            color: #fff;
            text-decoration: none;
            border-radius: 5px;
            font-size: 16px;
            text-align: center;
        }
        a:hover { background: #666; }
        .section-title { 
            color: #6a11cb; 
            border-bottom: 2px solid #6a11cb; 
            padding-bottom: 5px; 
            margin-top: 30px;
            font-size: 1.2em;
        }
        
        /* NEW: Subtitle Section Styles */
        .subtitle-info {
            background: #3a3a3c;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 13px;
            color: #ccc;
            border-left: 3px solid #6a11cb;
        }
        
        .subtitle-input-group {
            margin-bottom: 10px;
        }
        
        .subtitle-input-group label {
            font-size: 14px;
            color: #ccc;
            display: flex;
            align-items: center;
        }
        
        .subtitle-input-group label::before {
            content: "üéØ";
            margin-right: 8px;
        }
        
        .subtitle-input-group input {
            background: #5a606b;
        }
        
        .language-section {
            margin-bottom: 20px;
        }
        
        .language-section h4 {
            color: #8a2be2;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #444;
            font-size: 16px;
        }
        
        .help-text {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <h1>Add Episode for "{{ media.title }}"</h1>
    <form id="add-episode-form">
        <div>
            <label for="season_number">Season Number:</label>
            <input type="number" id="season_number" name="season_number" required>
        </div>
        <div>
            <label for="episode_number">Episode Number:</label>
            <input type="number" id="episode_number" name="episode_number" required>
        </div>
        <div>
            <label for="episode_name">Episode Name:</label>
            <input type="text" id="episode_name" name="episode_name" required>
        </div>
        
        <!-- NEW: Subtitles Section -->
        <div class="section-title">üéØ Subtitles (English & Sinhala)</div>
        <div class="subtitle-info">
            <strong>Format:</strong> Add comma-separated URLs for subtitle files (.vtt, .srt, .ass)<br>
            <strong>Example:</strong> https://example.com/episode_en.vtt, https://example.com/episode_en2.srt
        </div>
        
        <!-- English Subtitles -->
        <div class="language-section">
            <h4>English Subtitles</h4>
            <div class="subtitle-input-group">
                <label for="english_subtitles_720p">English 720p Subtitles:</label>
                <input type="text" id="english_subtitles_720p" name="english_subtitles_720p" placeholder="https://example.com/episode_720p_en.vtt">
            </div>
            <div class="subtitle-input-group">
                <label for="english_subtitles_1080p">English 1080p Subtitles:</label>
                <input type="text" id="english_subtitles_1080p" name="english_subtitles_1080p" placeholder="https://example.com/episode_1080p_en.vtt">
            </div>
            <div class="subtitle-input-group">
                <label for="english_subtitles_2160p">English 2160p Subtitles:</label>
                <input type="text" id="english_subtitles_2160p" name="english_subtitles_2160p" placeholder="https://example.com/episode_2160p_en.vtt">
            </div>
        </div>
        
        <!-- Sinhala Subtitles -->
        <div class="language-section">
            <h4>‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω ‡∂ã‡∂¥‡∑É‡∑í‡∂ª‡∑ê‡∑É‡∑í (Sinhala Subtitles)</h4>
            <div class="subtitle-input-group">
                <label for="sinhala_subtitles_720p">Sinhala 720p Subtitles:</label>
                <input type="text" id="sinhala_subtitles_720p" name="sinhala_subtitles_720p" placeholder="https://example.com/episode_720p_si.vtt">
            </div>
            <div class="subtitle-input-group">
                <label for="sinhala_subtitles_1080p">Sinhala 1080p Subtitles:</label>
                <input type="text" id="sinhala_subtitles_1080p" name="sinhala_subtitles_1080p" placeholder="https://example.com/episode_1080p_si.vtt">
            </div>
            <div class="subtitle-input-group">
                <label for="sinhala_subtitles_2160p">Sinhala 2160p Subtitles:</label>
                <input type="text" id="sinhala_subtitles_2160p" name="sinhala_subtitles_2160p" placeholder="https://example.com/episode_2160p_si.vtt">
            </div>
        </div>
        
        <!-- Alternative: Single subtitle field for all qualities -->
        <div class="language-section">
            <h4>Alternative: Single Subtitle URLs</h4>
            <div class="subtitle-input-group">
                <label for="english_subtitles_all">All English Subtitles (for all qualities):</label>
                <input type="text" id="english_subtitles_all" name="english_subtitles_all" placeholder="https://example.com/episode_en.vtt">
                <div class="help-text">This will apply to all video qualities if quality-specific subtitles are not provided</div>
            </div>
            <div class="subtitle-input-group">
                <label for="sinhala_subtitles_all">‡∑É‡∑í‡∂∫‡∂Ω‡∑î‡∂∏ ‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω ‡∂ã‡∂¥‡∑É‡∑í‡∂ª‡∑ê‡∑É‡∑í (All Sinhala Subtitles):</label>
                <input type="text" id="sinhala_subtitles_all" name="sinhala_subtitles_all" placeholder="https://example.com/episode_si.vtt">
                <div class="help-text">This will apply to all video qualities if quality-specific subtitles are not provided</div>
            </div>
        </div>
        
        <div class="section-title">üé¨ Video Links</div>
        <div>
            <label for="video_720p">720p Video Link:</label>
            <input type="text" id="video_720p" name="video_720p">
        </div>
        <div>
            <label for="video_1080p">1080p Video Link:</label>
            <input type="text" id="video_1080p" name="video_1080p">
        </div>
        <div>
            <label for="video_2160p">2160p Video Link:</label>
            <input type="text" id="video_2160p" name="video_2160p">
        </div>

        <div class="section-title">‚¨áÔ∏è Download Links</div>
        <div>
            <label for="download_720p">720p Download Link:</label>
            <input type="text" id="download_720p" name="download_720p">
        </div>
        <div>
            <label for="download_1080p">1080p Download Link:</label>
            <input type="text" id="download_1080p" name="download_1080p">
        </div>
        <div>
            <label for="download_2160p">2160p Download Link:</label>
            <input type="text" id="download_2160p" name="download_2160p">
        </div>

        <!-- NEW: Telegram Download Links Section -->
        <div class="section-title">üì± Telegram Download Links</div>
        <div>
            <label for="telegram_720p">720p Telegram Link:</label>
            <input type="text" id="telegram_720p" name="telegram_720p" placeholder="https://t.me/...">
        </div>
        <div>
            <label for="telegram_1080p">1080p Telegram Link:</label>
            <input type="text" id="telegram_1080p" name="telegram_1080p" placeholder="https://t.me/...">
        </div>
        <div>
            <label for="telegram_2160p">2160p Telegram Link:</label>
            <input type="text" id="telegram_2160p" name="telegram_2160p" placeholder="https://t.me/...">
        </div>

        <div class="section-title">üß≤ Torrent Links</div>
        <div>
            <label for="torrent_720p">720p Torrent Link:</label>
            <input type="text" id="torrent_720p" name="torrent_720p" placeholder="magnet:?xt=urn:btih:...">
        </div>
        <div>
            <label for="torrent_1080p">1080p Torrent Link:</label>
            <input type="text" id="torrent_1080p" name="torrent_1080p" placeholder="magnet:?xt=urn:btih:...">
        </div>
        <div>
            <label for="torrent_2160p">2160p Torrent Link:</label>
            <input type="text" id="torrent_2160p" name="torrent_2160p" placeholder="magnet:?xt=urn:btih:...">
        </div>

        <div class="button-group">
            <button type="submit">Save Episode</button>
            <a href="/admin/search_and_edit">Cancel</a>
        </div>
    </form>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Extract media ID from the URL
            const urlParams = new URLSearchParams(window.location.search);
            const mediaId = urlParams.get('media_id');
            if (!mediaId) {
                alert('Media ID not found in URL.');
                return;
            }

            // Function to parse subtitle URLs from comma-separated string
            function parseSubtitleUrls(input) {
                if (!input || input.trim() === '') return [];
                return input.split(',').map(url => url.trim()).filter(url => url !== '');
            }

            document.getElementById('add-episode-form').addEventListener('submit', async function(event) {
                event.preventDefault();
                const form = event.target;
                const formData = new FormData(form);

                // NEW: Parse subtitle URLs
                let englishSubtitles = [];
                let sinhalaSubtitles = [];
                
                // Collect quality-specific English subtitles
                const english720p = parseSubtitleUrls(formData.get('english_subtitles_720p'));
                const english1080p = parseSubtitleUrls(formData.get('english_subtitles_1080p'));
                const english2160p = parseSubtitleUrls(formData.get('english_subtitles_2160p'));
                const englishAll = parseSubtitleUrls(formData.get('english_subtitles_all'));
                
                // Collect quality-specific Sinhala subtitles
                const sinhala720p = parseSubtitleUrls(formData.get('sinhala_subtitles_720p'));
                const sinhala1080p = parseSubtitleUrls(formData.get('sinhala_subtitles_1080p'));
                const sinhala2160p = parseSubtitleUrls(formData.get('sinhala_subtitles_2160p'));
                const sinhalaAll = parseSubtitleUrls(formData.get('sinhala_subtitles_all'));
                
                // Combine subtitles: quality-specific first, then general
                englishSubtitles = [...new Set([...english720p, ...english1080p, ...english2160p, ...englishAll])];
                sinhalaSubtitles = [...new Set([...sinhala720p, ...sinhala1080p, ...sinhala2160p, ...sinhalaAll])];

                const videoLinks = {};
                if (formData.get('video_720p')) videoLinks['video_720p'] = formData.get('video_720p');
                if (formData.get('video_1080p')) videoLinks['video_1080p'] = formData.get('video_1080p');
                if (formData.get('video_2160p')) videoLinks['video_2160p'] = formData.get('video_2160p');

                const downloadLinks = {};
                if (formData.get('download_720p')) downloadLinks['download_720p'] = { url: formData.get('download_720p'), file_type: 'webrip' };
                if (formData.get('download_1080p')) downloadLinks['download_1080p'] = { url: formData.get('download_1080p'), file_type: 'webrip' };
                if (formData.get('download_2160p')) downloadLinks['download_2160p'] = { url: formData.get('download_2160p'), file_type: 'webrip' };

                // NEW: Telegram download links
                const telegramLinks = {};
                if (formData.get('telegram_720p')) telegramLinks['telegram_720p'] = formData.get('telegram_720p');
                if (formData.get('telegram_1080p')) telegramLinks['telegram_1080p'] = formData.get('telegram_1080p');
                if (formData.get('telegram_2160p')) telegramLinks['telegram_2160p'] = formData.get('telegram_2160p');

                const torrentLinks = {};
                if (formData.get('torrent_720p')) torrentLinks['torrent_720p'] = formData.get('torrent_720p');
                if (formData.get('torrent_1080p')) torrentLinks['torrent_1080p'] = formData.get('torrent_1080p');
                if (formData.get('torrent_2160p')) torrentLinks['torrent_2160p'] = formData.get('torrent_2160p');

                const data = {
                    season_number: parseInt(formData.get('season_number')),
                    episode_number: parseInt(formData.get('episode_number')),
                    episode_name: formData.get('episode_name'),
                    video_links: videoLinks,
                    download_links: downloadLinks,
                    telegram_links: telegramLinks,  // NEW: Include Telegram links
                    torrent_links: torrentLinks,
                    // NEW: Include subtitles
                    english_subtitles: englishSubtitles.join(', '),  // Send as comma-separated string
                    sinhala_subtitles: sinhalaSubtitles.join(', ')   // Send as comma-separated string
                };

                // For debugging
                console.log('Submitting episode data:', data);

                try {
                    const response = await fetch(`/api/admin/media/${mediaId}/episode`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Basic ' + btoa('venura:venura')
                        },
                        body: JSON.stringify(data)
                    });
                    const result = await response.json();
                    if (response.ok) {
                        alert('Episode saved successfully with subtitles!');
                        window.location.href = `/admin/edit?id=${mediaId}`;
                    } else {
                        alert('Error: ' + result.message);
                    }
                } catch (error) {
                    alert('An unexpected error occurred: ' + error.message);
                }
            });
        });
    </script>
</body>
</html>
