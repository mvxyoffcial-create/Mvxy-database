<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Media</title>
    <style>
        /* Your existing CSS remains the same */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1c1c1e;
            color: #f0f0f0;
            padding: 20px;
            margin: 0;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1100px;
            margin: 40px auto;
            background: #2c2c2e;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
        }

        .form-section {
            background: #3a3a3c;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #b0b0b0;
        }

        input[type="text"], input[type="number"], input[type="date"], select, textarea {
            width: 100%;
            padding: 12px;
            box-sizing: border-box;
            background: #4a4a4c;
            border: 1px solid #555;
            color: #fff;
            border-radius: 6px;
        }

        .btn-primary {
            background: linear-gradient(90deg, #6a11cb 0%, #2575fc 100%);
            color: #fff;
            width: 100%;
            margin-top: 20px;
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        /* TV Series Specific Styles */
        .season-container {
            border: 1px dashed #555;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            background-color: #2c2c2e;
        }
        
        .episode-container {
            margin-top: 15px;
            padding-left: 20px;
            border-left: 2px solid #6a11cb;
        }

        .episode-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .episode-row input {
            flex-grow: 1;
            min-width: 150px;
        }

        .btn-secondary {
            background-color: #555;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }

        .remove-btn {
            background: #ff4d4d;
            color: #fff;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }

        .section-title {
            color: #6a11cb;
            border-bottom: 2px solid #6a11cb;
            padding-bottom: 5px;
            margin-top: 30px;
            font-size: 1.2em;
        }

        /* NEW: Screenshots Styles */
        .screenshot-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .screenshot-input-group {
            margin-bottom: 10px;
        }

        .screenshot-input-group label {
            font-size: 14px;
            color: #ccc;
        }

        .help-text {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
            font-style: italic;
        }

        .inline-group {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .inline-group .form-group {
            flex: 1;
        }
        
        h2 {
            color: #6a11cb;
            border-bottom: 2px solid #6a11cb;
            padding-bottom: 8px;
            margin-top: 30px;
        }
        
        h3 {
            color: #8a2be2;
            margin: 20px 0 15px 0;
            font-size: 1.1em;
        }

        /* NEW: Subtitles Styles */
        .subtitle-section {
            background: #3a3a3c;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #6a11cb;
        }

        .subtitle-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .subtitle-input-group {
            margin-bottom: 10px;
        }

        .subtitle-input-group label {
            font-size: 14px;
            color: #ccc;
            display: flex;
            align-items: center;
        }

        .subtitle-input-group label::before {
            content: "üéØ";
            margin-right: 8px;
        }

        .subtitle-input-group input {
            background: #5a606b;
        }

        .subtitle-info {
            background: #5a606b;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 12px;
            color: #ccc;
            margin-bottom: 15px;
        }

        .language-section {
            margin-bottom: 20px;
        }

        .language-section h3 {
            color: #6a11cb;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #444;
        }

        .section-toggle {
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .section-toggle::after {
            content: "‚ñº";
            transition: transform 0.3s;
        }

        .section-toggle.collapsed::after {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }

        .collapsible-content.collapsed {
            max-height: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚úèÔ∏è Edit Media</h1>
        
        <div id="loading-error" class="error-message" style="display: none;">
            Error: Cannot load media. Please ensure the ID is valid and the backend is running.
        </div>

        <div id="success-message" class="success-message" style="display: none;"></div>
        
        <form id="edit-media-form">
            <input type="hidden" id="media-id" name="id">
            
            <div class="form-section">
                <h2>Media Details</h2>
                <div class="form-group">
                    <label for="type">Media Type:</label>
                    <input type="text" id="type" name="type" readonly>
                </div>
                <div class="form-group">
                    <label for="title">Title: *</label>
                    <input type="text" id="title" name="title" required>
                </div>
                <div class="form-group">
                    <label for="description">Description:</label>
                    <textarea id="description" name="description" placeholder="Enter description..."></textarea>
                </div>
                
                <div class="inline-group">
                    <div class="form-group">
                        <label for="thumbnail">Thumbnail URL:</label>
                        <input type="text" id="thumbnail" name="thumbnail" placeholder="https://example.com/poster.jpg">
                    </div>
                    <div class="form-group">
                        <label for="backdrop">Backdrop Image URL:</label>
                        <input type="text" id="backdrop" name="backdrop" placeholder="https://example.com/backdrop.jpg">
                    </div>
                </div>
                
                <div class="inline-group">
                    <div class="form-group">
                        <label for="release_date">Release Date:</label>
                        <input type="date" id="release_date" name="release_date">
                    </div>
                    <div class="form-group">
                        <label for="language">Language:</label>
                        <input type="text" id="language" name="language" placeholder="en">
                    </div>
                    <div class="form-group">
                        <label for="rating">Rating:</label>
                        <input type="number" step="0.1" id="rating" name="rating" placeholder="7.5" min="0" max="10">
                    </div>
                </div>
                
                <!-- NEW: Source Type Selection -->
                <div class="inline-group">
                    <div class="form-group">
                        <label for="source_type">Source Type:</label>
                        <select id="source_type" name="source_type">
                            <option value="original">Original</option>
                            <option value="camcopy">CamCopy</option>
                            <option value="bluray">BluRay</option>
                            <option value="webrip">WebRip</option>
                            <option value="webdl">WebDL</option>
                            <option value="hdtv">HDTV</option>
                            <option value="dvdrip">DVDRip</option>
                            <option value="brrip">BRRip</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="file_type">File Type:</label>
                        <select id="file_type" name="file_type">
                            <option value="webrip">WebRip</option>
                            <option value="bluray">BluRay</option>
                            <option value="webdl">WebDL</option>
                            <option value="hdtv">HDTV</option>
                            <option value="dvd">DVD</option>
                            <option value="brrip">BRRip</option>
                            <option value="bdrip">BDRip</option>
                        </select>
                    </div>
                </div>
                
                <!-- NEW: YouTube Trailer -->
                <div class="form-group">
                    <label for="youtube_trailer">YouTube Trailer URL:</label>
                    <input type="text" id="youtube_trailer" name="youtube_trailer" placeholder="https://youtube.com/watch?v=... or https://youtu.be/...">
                    <div class="help-text">Enter YouTube URL or Video ID</div>
                </div>
                
                <!-- NEW: Status Field for TV Series -->
                <div class="form-group" id="status-field" style="display: none;">
                    <label for="status">TV Series Status:</label>
                    <input type="text" id="status" name="status" placeholder="e.g., Ongoing, Finished, Cancelled">
                </div>

                <div class="form-group">
                    <label for="genres">Genres (comma-separated):</label>
                    <input type="text" id="genres" name="genres" placeholder="Action, Drama, Comedy">
                </div>
                <div class="form-group">
                    <label for="cast_members">Cast (JSON):</label>
                    <textarea id="cast_members" name="cast_members" placeholder='[{"name": "Actor Name", "character": "Character Name"}]'></textarea>
                </div>
            </div>
            
            <!-- NEW: Subtitles Section -->
            <div class="form-section" id="subtitles-section" style="display: none;">
                <h2 class="section-toggle" onclick="toggleSection('subtitles-content')">üéØ Subtitles (English & Sinhala)</h2>
                <div id="subtitles-content" class="collapsible-content">
                    <div class="subtitle-info">
                        <strong>Format:</strong> Add comma-separated URLs for subtitle files (.vtt, .srt, .ass)<br>
                        <strong>Example:</strong> https://example.com/subtitles_en.vtt, https://example.com/subtitles_en2.srt
                    </div>
                    
                    <!-- English Subtitles -->
                    <div class="language-section">
                        <h3>English Subtitles</h3>
                        <div class="subtitle-grid">
                            <div class="subtitle-input-group">
                                <label for="english_subtitles_720p">English 720p Subtitles:</label>
                                <input type="text" id="english_subtitles_720p" name="english_subtitles_720p" placeholder="https://example.com/english_720p.vtt, https://example.com/english_720p.srt">
                            </div>
                            <div class="subtitle-input-group">
                                <label for="english_subtitles_1080p">English 1080p Subtitles:</label>
                                <input type="text" id="english_subtitles_1080p" name="english_subtitles_1080p" placeholder="https://example.com/english_1080p.vtt, https://example.com/english_1080p.srt">
                            </div>
                            <div class="subtitle-input-group">
                                <label for="english_subtitles_2160p">English 2160p Subtitles:</label>
                                <input type="text" id="english_subtitles_2160p" name="english_subtitles_2160p" placeholder="https://example.com/english_2160p.vtt, https://example.com/english_2160p.srt">
                            </div>
                        </div>
                    </div>

                    <!-- Sinhala Subtitles -->
                    <div class="language-section">
                        <h3>‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω ‡∂ã‡∂¥‡∑É‡∑í‡∂ª‡∑ê‡∑É‡∑í (Sinhala Subtitles)</h3>
                        <div class="subtitle-grid">
                            <div class="subtitle-input-group">
                                <label for="sinhala_subtitles_720p">Sinhala 720p Subtitles:</label>
                                <input type="text" id="sinhala_subtitles_720p" name="sinhala_subtitles_720p" placeholder="https://example.com/sinhala_720p.vtt, https://example.com/sinhala_720p.srt">
                            </div>
                            <div class="subtitle-input-group">
                                <label for="sinhala_subtitles_1080p">Sinhala 1080p Subtitles:</label>
                                <input type="text" id="sinhala_subtitles_1080p" name="sinhala_subtitles_1080p" placeholder="https://example.com/sinhala_1080p.vtt, https://example.com/sinhala_1080p.srt">
                            </div>
                            <div class="subtitle-input-group">
                                <label for="sinhala_subtitles_2160p">Sinhala 2160p Subtitles:</label>
                                <input type="text" id="sinhala_subtitles_2160p" name="sinhala_subtitles_2160p" placeholder="https://example.com/sinhala_2160p.vtt, https://example.com/sinhala_2160p.srt">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Alternative: Single subtitle field for all qualities -->
                    <div class="language-section">
                        <h3>Alternative: Single Subtitle URLs</h3>
                        <div class="subtitle-grid">
                            <div class="subtitle-input-group">
                                <label for="english_subtitles_all">All English Subtitles (for all qualities):</label>
                                <input type="text" id="english_subtitles_all" name="english_subtitles_all" placeholder="https://example.com/english_all.vtt">
                                <div class="help-text">This will apply to all video qualities if quality-specific subtitles are not provided</div>
                            </div>
                            <div class="subtitle-input-group">
                                <label for="sinhala_subtitles_all">‡∑É‡∑í‡∂∫‡∂Ω‡∑î‡∂∏ ‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω ‡∂ã‡∂¥‡∑É‡∑í‡∂ª‡∑ê‡∑É‡∑í (All Sinhala Subtitles):</label>
                                <input type="text" id="sinhala_subtitles_all" name="sinhala_subtitles_all" placeholder="https://example.com/sinhala_all.vtt">
                                <div class="help-text">This will apply to all video qualities if quality-specific subtitles are not provided</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Screenshots Section -->
            <div class="form-section" id="screenshots-section" style="display: none;">
                <h2 class="section-toggle" onclick="toggleSection('screenshots-content')">üì∏ Screenshots</h2>
                <div id="screenshots-content" class="collapsible-content">
                    <!-- 720p Screenshots -->
                    <h3>720p Screenshots (2 Required)</h3>
                    <div class="screenshot-grid">
                        <div class="screenshot-input-group">
                            <label for="screenshots_720p_1">720p Screenshot 1 URL:</label>
                            <input type="text" id="screenshots_720p_1" name="screenshots_720p_1" placeholder="https://example.com/screenshot1_720.jpg">
                        </div>
                        <div class="screenshot-input-group">
                            <label for="screenshots_720p_2">720p Screenshot 2 URL:</label>
                            <input type="text" id="screenshots_720p_2" name="screenshots_720p_2" placeholder="https://example.com/screenshot2_720.jpg">
                        </div>
                    </div>

                    <!-- 1080p Screenshots -->
                    <h3>1080p Screenshots (2 Required)</h3>
                    <div class="screenshot-grid">
                        <div class="screenshot-input-group">
                            <label for="screenshots_1080p_1">1080p Screenshot 1 URL:</label>
                            <input type="text" id="screenshots_1080p_1" name="screenshots_1080p_1" placeholder="https://example.com/screenshot1_1080.jpg">
                        </div>
                        <div class="screenshot-input-group">
                            <label for="screenshots_1080p_2">1080p Screenshot 2 URL:</label>
                            <input type="text" id="screenshots_1080p_2" name="screenshots_1080p_2" placeholder="https://example.com/screenshot2_1080.jpg">
                        </div>
                    </div>

                    <!-- 2160p Screenshots -->
                    <h3>2160p Screenshots (2 Required)</h3>
                    <div class="screenshot-grid">
                        <div class="screenshot-input-group">
                            <label for="screenshots_2160p_1">2160p Screenshot 1 URL:</label>
                            <input type="text" id="screenshots_2160p_1" name="screenshots_2160p_1" placeholder="https://example.com/screenshot1_2160.jpg">
                        </div>
                        <div class="screenshot-input-group">
                            <label for="screenshots_2160p_2">2160p Screenshot 2 URL:</label>
                            <input type="text" id="screenshots_2160p_2" name="screenshots_2160p_2" placeholder="https://example.com/screenshot2_2160.jpg">
                        </div>
                    </div>

                    <!-- Trailer Screenshots (Optional) -->
                    <h3>Trailer Screenshots (Optional)</h3>
                    <div class="screenshot-grid">
                        <div class="screenshot-input-group">
                            <label for="screenshots_trailer_1">Trailer Screenshot 1 URL:</label>
                            <input type="text" id="screenshots_trailer_1" name="screenshots_trailer_1" placeholder="https://example.com/trailer_screenshot1.jpg">
                        </div>
                        <div class="screenshot-input-group">
                            <label for="screenshots_trailer_2">Trailer Screenshot 2 URL:</label>
                            <input type="text" id="screenshots_trailer_2" name="screenshots_trailer_2" placeholder="https://example.com/trailer_screenshot2.jpg">
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="dynamic-fields"></div>

            <button type="submit" class="btn-primary">Update Media</button>
        </form>
    </div>

    <script>
        const API_BASE_URL = window.location.origin + '/api/media';
        const ADMIN_API_BASE_URL = window.location.origin + '/api/admin';
        const AUTH_HEADER = 'Basic ' + btoa('venura:venura');
        let seasonNumberCounter = 0;

        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const mediaId = urlParams.get('id');
            if (!mediaId) {
                document.getElementById('loading-error').style.display = 'block';
                return;
            }
            document.getElementById('media-id').value = mediaId;
            await loadMediaData(mediaId);
        });

        // Function to toggle section visibility
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const toggle = section.previousElementSibling;
            
            section.classList.toggle('collapsed');
            toggle.classList.toggle('collapsed');
        }

        // Parse subtitle URLs from comma-separated string
        function parseSubtitleUrls(input) {
            if (!input || input.trim() === '') return [];
            return input.split(',').map(url => url.trim()).filter(url => url !== '');
        }

        async function loadMediaData(id) {
            try {
                const response = await fetch(`${API_BASE_URL}/${id}`);
                if (!response.ok) {
                    throw new Error('Media not found.');
                }
                const media = await response.json();
                console.log('Loaded media data:', media);
                
                // Parse JSON strings if needed
                if (typeof media.video_links === 'string') {
                    try {
                        media.video_links = JSON.parse(media.video_links);
                    } catch (e) {
                        media.video_links = {};
                    }
                }
                
                if (typeof media.download_links === 'string') {
                    try {
                        media.download_links = JSON.parse(media.download_links);
                    } catch (e) {
                        media.download_links = {};
                    }
                }
                
                // NEW: Parse telegram_links
                if (typeof media.telegram_links === 'string') {
                    try {
                        media.telegram_links = JSON.parse(media.telegram_links);
                    } catch (e) {
                        media.telegram_links = {};
                    }
                }
                
                if (typeof media.torrent_links === 'string') {
                    try {
                        media.torrent_links = JSON.parse(media.torrent_links);
                    } catch (e) {
                        media.torrent_links = {};
                    }
                }
                
                // NEW: Parse screenshot fields
                if (typeof media.screenshots_720p === 'string') {
                    try {
                        media.screenshots_720p = JSON.parse(media.screenshots_720p);
                    } catch (e) {
                        media.screenshots_720p = [];
                    }
                }
                
                if (typeof media.screenshots_1080p === 'string') {
                    try {
                        media.screenshots_1080p = JSON.parse(media.screenshots_1080p);
                    } catch (e) {
                        media.screenshots_1080p = [];
                    }
                }
                
                if (typeof media.screenshots_2160p === 'string') {
                    try {
                        media.screenshots_2160p = JSON.parse(media.screenshots_2160p);
                    } catch (e) {
                        media.screenshots_2160p = [];
                    }
                }
                
                if (typeof media.screenshots_trailer === 'string') {
                    try {
                        media.screenshots_trailer = JSON.parse(media.screenshots_trailer);
                    } catch (e) {
                        media.screenshots_trailer = [];
                    }
                }
                
                // NEW: Parse subtitles field
                if (typeof media.subtitles === 'string') {
                    try {
                        media.subtitles = JSON.parse(media.subtitles);
                    } catch (e) {
                        media.subtitles = { english: [], sinhala: [] };
                    }
                } else if (!media.subtitles) {
                    media.subtitles = { english: [], sinhala: [] };
                }
                
                if (typeof media.cast_members === 'string') {
                    try {
                        media.cast_members = JSON.parse(media.cast_members);
                    } catch (e) {
                        media.cast_members = [];
                    }
                }
                
                if (typeof media.genres === 'string') {
                    try {
                        media.genres = JSON.parse(media.genres);
                    } catch (e) {
                        media.genres = [];
                    }
                }
                
                if (typeof media.seasons === 'string') {
                    try {
                        media.seasons = JSON.parse(media.seasons);
                    } catch (e) {
                        media.seasons = null;
                    }
                }
                
                populateForm(media);
            } catch (err) {
                console.error("Failed to load media:", err);
                document.getElementById('loading-error').style.display = 'block';
            }
        }

        function populateForm(media) {
            console.log('Populating form with:', media);
            
            // Basic fields
            document.getElementById('type').value = media.type || '';
            document.getElementById('title').value = media.title || '';
            document.getElementById('description').value = media.description || '';
            document.getElementById('thumbnail').value = media.thumbnail || '';
            document.getElementById('backdrop').value = media.backdrop || '';
            document.getElementById('release_date').value = media.release_date || '';
            document.getElementById('language').value = media.language || '';
            document.getElementById('rating').value = media.rating || '';
            document.getElementById('file_type').value = media.file_type || 'webrip';
            document.getElementById('source_type').value = media.source_type || 'original'; // NEW: Source type
            document.getElementById('youtube_trailer').value = media.youtube_trailer || ''; // NEW: YouTube trailer
            
            // NEW: Show status field for TV series and populate it
            if (media.type === 'tv') {
                document.getElementById('status-field').style.display = 'block';
                document.getElementById('status').value = media.status || '';
            } else {
                document.getElementById('status-field').style.display = 'none';
            }
            
            // NEW: Show screenshots section for all media types
            document.getElementById('screenshots-section').style.display = 'block';
            
            // NEW: Show subtitles section for all media types
            document.getElementById('subtitles-section').style.display = 'block';
            
            // NEW: Populate screenshot fields
            if (media.screenshots_720p && Array.isArray(media.screenshots_720p)) {
                document.getElementById('screenshots_720p_1').value = media.screenshots_720p[0] || '';
                document.getElementById('screenshots_720p_2').value = media.screenshots_720p[1] || '';
            }
            
            if (media.screenshots_1080p && Array.isArray(media.screenshots_1080p)) {
                document.getElementById('screenshots_1080p_1').value = media.screenshots_1080p[0] || '';
                document.getElementById('screenshots_1080p_2').value = media.screenshots_1080p[1] || '';
            }
            
            if (media.screenshots_2160p && Array.isArray(media.screenshots_2160p)) {
                document.getElementById('screenshots_2160p_1').value = media.screenshots_2160p[0] || '';
                document.getElementById('screenshots_2160p_2').value = media.screenshots_2160p[1] || '';
            }
            
            if (media.screenshots_trailer && Array.isArray(media.screenshots_trailer)) {
                document.getElementById('screenshots_trailer_1').value = media.screenshots_trailer[0] || '';
                document.getElementById('screenshots_trailer_2').value = media.screenshots_trailer[1] || '';
            }
            
            // NEW: Populate subtitle fields
            if (media.subtitles) {
                const englishSubtitles = media.subtitles.english || [];
                const sinhalaSubtitles = media.subtitles.sinhala || [];
                
                // For simplicity, we'll populate the "all" fields with all subtitles
                if (englishSubtitles.length > 0) {
                    document.getElementById('english_subtitles_all').value = englishSubtitles.join(', ');
                }
                
                if (sinhalaSubtitles.length > 0) {
                    document.getElementById('sinhala_subtitles_all').value = sinhalaSubtitles.join(', ');
                }
                
                // You could add more sophisticated logic to separate by quality if needed
            }
            
            // Genres
            document.getElementById('genres').value = (media.genres && Array.isArray(media.genres)) ? media.genres.join(', ') : '';

            // Cast members
            try {
                document.getElementById('cast_members').value = JSON.stringify(media.cast_members || [], null, 2);
            } catch (e) {
                document.getElementById('cast_members').value = '[]';
            }

            const dynamicFieldsContainer = document.getElementById('dynamic-fields');
            dynamicFieldsContainer.innerHTML = '';

            if (media.type === 'movie') {
                // Extract video links
                let video720 = '';
                let video1080 = '';
                let video2160 = '';
                
                if (media.video_links && typeof media.video_links === 'object') {
                    video720 = media.video_links['video_720p'] || '';
                    video1080 = media.video_links['video_1080p'] || '';
                    video2160 = media.video_links['video_2160p'] || '';
                }
                
                // Extract download links - handle nested objects
                let download720 = '';
                let download1080 = '';
                let download2160 = '';
                
                if (media.download_links && typeof media.download_links === 'object') {
                    // Handle nested object structure: {"download_720p": {"url": "https://...", "file_type": "webrip"}}
                    const dl720 = media.download_links['download_720p'];
                    const dl1080 = media.download_links['download_1080p'];
                    const dl2160 = media.download_links['download_2160p'];
                    
                    download720 = (dl720 && dl720.url) ? dl720.url : '';
                    download1080 = (dl1080 && dl1080.url) ? dl1080.url : '';
                    download2160 = (dl2160 && dl2160.url) ? dl2160.url : '';
                }
                
                // NEW: Extract Telegram download links
                let telegram720 = '';
                let telegram1080 = '';
                let telegram2160 = '';
                
                if (media.telegram_links && typeof media.telegram_links === 'object') {
                    telegram720 = media.telegram_links['telegram_720p'] || '';
                    telegram1080 = media.telegram_links['telegram_1080p'] || '';
                    telegram2160 = media.telegram_links['telegram_2160p'] || '';
                }
                
                // Extract torrent links
                let torrent720 = '';
                let torrent1080 = '';
                let torrent2160 = '';
                
                if (media.torrent_links && typeof media.torrent_links === 'object') {
                    torrent720 = media.torrent_links['torrent_720p'] || '';
                    torrent1080 = media.torrent_links['torrent_1080p'] || '';
                    torrent2160 = media.torrent_links['torrent_2160p'] || '';
                }
                
                dynamicFieldsContainer.innerHTML = `
                    <div class="form-section">
                        <h2>üîó Video Links</h2>
                        <div class="form-group">
                            <label for="video_720p">720p Video URL:</label>
                            <input type="text" id="video_720p" name="video_720p" placeholder="https://example.com/video_720p.mp4" value="${video720}">
                        </div>
                        <div class="form-group">
                            <label for="video_1080p">1080p Video URL:</label>
                            <input type="text" id="video_1080p" name="video_1080p" placeholder="https://example.com/video_1080p.mp4" value="${video1080}">
                        </div>
                        <div class="form-group">
                            <label for="video_2160p">2160p Video URL:</label>
                            <input type="text" id="video_2160p" name="video_2160p" placeholder="https://example.com/video_2160p.mp4" value="${video2160}">
                        </div>

                        <h2>‚¨áÔ∏è Download Links</h2>
                        <div class="form-group">
                            <label for="download_720p">720p Download URL:</label>
                            <input type="text" id="download_720p" name="download_720p" placeholder="https://example.com/download_720p.mp4" value="${download720}">
                        </div>
                        <div class="form-group">
                            <label for="download_1080p">1080p Download URL:</label>
                            <input type="text" id="download_1080p" name="download_1080p" placeholder="https://example.com/download_1080p.mp4" value="${download1080}">
                        </div>
                        <div class="form-group">
                            <label for="download_2160p">2160p Download URL:</label>
                            <input type="text" id="download_2160p" name="download_2160p" placeholder="https://example.com/download_2160p.mp4" value="${download2160}">
                        </div>

                        <!-- Telegram Download Links Section -->
                        <h2>üì± Telegram Download Links</h2>
                        <div class="form-group">
                            <label for="telegram_720p">720p Telegram URL:</label>
                            <input type="text" id="telegram_720p" name="telegram_720p" placeholder="https://t.me/..." value="${telegram720}">
                        </div>
                        <div class="form-group">
                            <label for="telegram_1080p">1080p Telegram URL:</label>
                            <input type="text" id="telegram_1080p" name="telegram_1080p" placeholder="https://t.me/..." value="${telegram1080}">
                        </div>
                        <div class="form-group">
                            <label for="telegram_2160p">2160p Telegram URL:</label>
                            <input type="text" id="telegram_2160p" name="telegram_2160p" placeholder="https://t.me/..." value="${telegram2160}">
                        </div>

                        <h2>üß≤ Torrent Links</h2>
                        <div class="form-group">
                            <label for="torrent_720p">720p Torrent URL:</label>
                            <input type="text" id="torrent_720p" name="torrent_720p" placeholder="magnet:?xt=urn:btih:..." value="${torrent720}">
                        </div>
                        <div class="form-group">
                            <label for="torrent_1080p">1080p Torrent URL:</label>
                            <input type="text" id="torrent_1080p" name="torrent_1080p" placeholder="magnet:?xt=urn:btih:..." value="${torrent1080}">
                        </div>
                        <div class="form-group">
                            <label for="torrent_2160p">2160p Torrent URL:</label>
                            <input type="text" id="torrent_2160p" name="torrent_2160p" placeholder="magnet:?xt=urn:btih:..." value="${torrent2160}">
                        </div>
                    </div>
                `;
            } else if (media.type === 'tv') {
                // Get TV series video links
                const tvVideo720 = media.video_links ? (media.video_links['video_720p'] || '') : '';
                const tvVideo1080 = media.video_links ? (media.video_links['video_1080p'] || '') : '';
                const tvVideo2160 = media.video_links ? (media.video_links['video_2160p'] || '') : '';
                
                // Get TV series Telegram links
                const tvTelegram720 = media.telegram_links ? (media.telegram_links['telegram_720p'] || '') : '';
                const tvTelegram1080 = media.telegram_links ? (media.telegram_links['telegram_1080p'] || '') : '';
                const tvTelegram2160 = media.telegram_links ? (media.telegram_links['telegram_2160p'] || '') : '';
                
                dynamicFieldsContainer.innerHTML = `
                    <div class="form-section">
                        <h2>TV Series Details</h2>
                        <div class="form-group">
                            <label for="total_seasons">Total Seasons:</label>
                            <input type="number" id="total_seasons" name="total_seasons" value="${media.total_seasons || 0}">
                        </div>
                        
                        <h2>üîó TV Series Video Links</h2>
                        <div class="form-group">
                            <label for="tv_video_720p">720p Video URL:</label>
                            <input type="text" id="tv_video_720p" name="tv_video_720p" placeholder="https://example.com/series_720p/" value="${tvVideo720}">
                        </div>
                        <div class="form-group">
                            <label for="tv_video_1080p">1080p Video URL:</label>
                            <input type="text" id="tv_video_1080p" name="tv_video_1080p" placeholder="https://example.com/series_1080p/" value="${tvVideo1080}">
                        </div>
                        <div class="form-group">
                            <label for="tv_video_2160p">2160p Video URL:</label>
                            <input type="text" id="tv_video_2160p" name="tv_video_2160p" placeholder="https://example.com/series_2160p/" value="${tvVideo2160}">
                        </div>

                        <!-- TV Series Telegram Links -->
                        <h2>üì± TV Series Telegram Links</h2>
                        <div class="form-group">
                            <label for="tv_telegram_720p">720p Telegram URL:</label>
                            <input type="text" id="tv_telegram_720p" name="tv_telegram_720p" placeholder="https://t.me/..." value="${tvTelegram720}">
                        </div>
                        <div class="form-group">
                            <label for="tv_telegram_1080p">1080p Telegram URL:</label>
                            <input type="text" id="tv_telegram_1080p" name="tv_telegram_1080p" placeholder="https://t.me/..." value="${tvTelegram1080}">
                        </div>
                        <div class="form-group">
                            <label for="tv_telegram_2160p">2160p Telegram URL:</label>
                            <input type="text" id="tv_telegram_2160p" name="tv_telegram_2160p" placeholder="https://t.me/..." value="${tvTelegram2160}">
                        </div>
                        
                        <!-- TV Series Download Links -->
                        <h2>‚¨áÔ∏è TV Series Download Links</h2>
                        <div class="form-group">
                            <label for="tv_download_720p">720p Download URL:</label>
                            <input type="text" id="tv_download_720p" name="tv_download_720p" placeholder="https://example.com/download_720p.mp4">
                        </div>
                        <div class="form-group">
                            <label for="tv_download_1080p">1080p Download URL:</label>
                            <input type="text" id="tv_download_1080p" name="tv_download_1080p" placeholder="https://example.com/download_1080p.mp4">
                        </div>
                        <div class="form-group">
                            <label for="tv_download_2160p">2160p Download URL:</label>
                            <input type="text" id="tv_download_2160p" name="tv_download_2160p" placeholder="https://example.com/download_2160p.mp4">
                        </div>
                        
                        <!-- TV Series Torrent Links -->
                        <h2>üß≤ TV Series Torrent Links</h2>
                        <div class="form-group">
                            <label for="tv_torrent_720p">720p Torrent URL:</label>
                            <input type="text" id="tv_torrent_720p" name="tv_torrent_720p" placeholder="magnet:?xt=urn:btih:...">
                        </div>
                        <div class="form-group">
                            <label for="tv_torrent_1080p">1080p Torrent URL:</label>
                            <input type="text" id="tv_torrent_1080p" name="tv_torrent_1080p" placeholder="magnet:?xt=urn:btih:...">
                        </div>
                        <div class="form-group">
                            <label for="tv_torrent_2160p">2160p Torrent URL:</label>
                            <input type="text" id="tv_torrent_2160p" name="tv_torrent_2160p" placeholder="magnet:?xt=urn:btih:...">
                        </div>
                        
                        <div id="seasons-container"></div>
                        <button type="button" class="btn-secondary" onclick="addSeason()">Add New Season</button>
                    </div>
                `;
                
                // Populate seasons after a brief delay
                setTimeout(() => {
                    if (media.seasons && typeof media.seasons === 'object') {
                        const seasonKeys = Object.keys(media.seasons).sort((a, b) => {
                            const aNum = parseInt(a.split('_')[1]) || 0;
                            const bNum = parseInt(b.split('_')[1]) || 0;
                            return aNum - bNum;
                        });
                        seasonKeys.forEach(key => {
                            const season = media.seasons[key];
                            if (season) {
                                addSeason(season);
                            }
                        });
                    }
                    console.log('TV links populated successfully');
                }, 50);
            }
        }

        function addSeason(seasonData = null) {
            seasonNumberCounter++;
            const container = document.getElementById('seasons-container');
            const seasonDiv = document.createElement('div');
            seasonDiv.classList.add('season-container');
            const seasonNumber = seasonData ? seasonData.season_number : seasonNumberCounter;
            seasonDiv.innerHTML = `
                <h3>Season ${seasonNumber} <button type="button" class="remove-btn" onclick="removeSeason(this)">Remove</button></h3>
                <div class="form-group">
                    <label>Episodes</label>
                    <div class="episode-container" data-season-number="${seasonNumber}"></div>
                </div>
                <button type="button" class="btn-secondary" onclick="addEpisode(this)">+ Add Episode</button>
            `;
            container.appendChild(seasonDiv);
            
            if (seasonData && seasonData.episodes) {
                seasonData.episodes.forEach(episode => {
                    addEpisode(seasonDiv.querySelector('.btn-secondary'), episode);
                });
            }
        }

        function removeSeason(button) {
            if (confirm('Are you sure you want to remove this season and all its episodes?')) {
                button.closest('.season-container').remove();
            }
        }

        function addEpisode(button, episodeData = null) {
            const episodeContainer = button.previousElementSibling.querySelector('.episode-container');
            const seasonNumber = episodeContainer.dataset.seasonNumber;
            const episodeCount = episodeContainer.children.length + 1;
            const episodeDiv = document.createElement('div');
            episodeDiv.classList.add('episode-row');
            
            const episodeName = episodeData ? (episodeData.episode_name || '') : '';
            const video720p = episodeData ? (episodeData.video_720p || '') : '';
            const video1080p = episodeData ? (episodeData.video_1080p || '') : '';
            const video2160p = episodeData ? (episodeData.video_2160p || '') : '';
            
            // Handle download links properly - check for both object and string formats
            let download720p = '';
            let download1080p = '';
            let download2160p = '';
            
            if (episodeData) {
                const dl720 = episodeData.download_720p;
                const dl1080 = episodeData.download_1080p;
                const dl2160 = episodeData.download_2160p;
                
                download720p = (typeof dl720 === 'object' && dl720 !== null) ? dl720.url : (dl720 || '');
                download1080p = (typeof dl1080 === 'object' && dl1080 !== null) ? dl1080.url : (dl1080 || '');
                download2160p = (typeof dl2160 === 'object' && dl2160 !== null) ? dl2160.url : (dl2160 || '');
            }
            
            // Handle Telegram download links
            const telegram720p = episodeData ? (episodeData.telegram_720p || '') : '';
            const telegram1080p = episodeData ? (episodeData.telegram_1080p || '') : '';
            const telegram2160p = episodeData ? (episodeData.telegram_2160p || '') : '';
            
            const torrent720p = episodeData ? (episodeData.torrent_720p || '') : '';
            const torrent1080p = episodeData ? (episodeData.torrent_1080p || '') : '';
            const torrent2160p = episodeData ? (episodeData.torrent_2160p || '') : '';
            
            // NEW: Handle episode subtitles
            const episodeSubtitles = episodeData ? (episodeData.subtitles || { english: [], sinhala: [] }) : { english: [], sinhala: [] };
            const episodeEnglishSubtitles = Array.isArray(episodeSubtitles.english) ? episodeSubtitles.english.join(', ') : '';
            const episodeSinhalaSubtitles = Array.isArray(episodeSubtitles.sinhala) ? episodeSubtitles.sinhala.join(', ') : '';
            
            episodeDiv.innerHTML = `
                <input type="text" name="season_${seasonNumber}_episode_${episodeCount}_name" placeholder="Episode Name" value="${episodeName}" required style="flex-basis: 100%;">
                
                <!-- Video Links -->
                <input type="text" name="season_${seasonNumber}_episode_${episodeCount}_video_720p" placeholder="720p Video Link" value="${video720p}">
                <input type="text" name="season_${seasonNumber}_episode_${episodeCount}_video_1080p" placeholder="1080p Video Link" value="${video1080p}">
                <input type="text" name="season_${seasonNumber}_episode_${episodeCount}_video_2160p" placeholder="2160p Video Link" value="${video2160p}">
                
                <!-- Download Links -->
                <input type="text" name="season_${seasonNumber}_episode_${episodeCount}_download_720p" placeholder="720p Download Link" value="${download720p}">
                <input type="text" name="season_${seasonNumber}_episode_${episodeCount}_download_1080p" placeholder="1080p Download Link" value="${download1080p}">
                <input type="text" name="season_${seasonNumber}_episode_${episodeCount}_download_2160p" placeholder="2160p Download Link" value="${download2160p}">
                
                <!-- Telegram Links -->
                <input type="text" name="season_${seasonNumber}_episode_${episodeCount}_telegram_720p" placeholder="720p Telegram Link" value="${telegram720p}">
                <input type="text" name="season_${seasonNumber}_episode_${episodeCount}_telegram_1080p" placeholder="1080p Telegram Link" value="${telegram1080p}">
                <input type="text" name="season_${seasonNumber}_episode_${episodeCount}_telegram_2160p" placeholder="2160p Telegram Link" value="${telegram2160p}">
                
                <!-- Torrent Links -->
                <input type="text" name="season_${seasonNumber}_episode_${episodeCount}_torrent_720p" placeholder="720p Torrent Link" value="${torrent720p}">
                <input type="text" name="season_${seasonNumber}_episode_${episodeCount}_torrent_1080p" placeholder="1080p Torrent Link" value="${torrent1080p}">
                <input type="text" name="season_${seasonNumber}_episode_${episodeCount}_torrent_2160p" placeholder="2160p Torrent Link" value="${torrent2160p}">
                
                <!-- NEW: Episode Subtitles -->
                <input type="text" name="season_${seasonNumber}_episode_${episodeCount}_english_subtitles" placeholder="English Subtitles (comma-separated)" value="${episodeEnglishSubtitles}" style="flex-basis: 100%;">
                <input type="text" name="season_${seasonNumber}_episode_${episodeCount}_sinhala_subtitles" placeholder="Sinhala Subtitles (comma-separated)" value="${episodeSinhalaSubtitles}" style="flex-basis: 100%;">
                
                <button type="button" class="remove-btn" onclick="removeEpisode(this)">Remove</button>
            `;
            episodeContainer.appendChild(episodeDiv);
        }

        function removeEpisode(button) {
            if (confirm('Are you sure you want to remove this episode?')) {
                button.closest('.episode-row').remove();
            }
        }

        document.getElementById('edit-media-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const mediaId = document.getElementById('media-id').value;
            const mediaType = document.getElementById('type').value;
            const fileType = document.getElementById('file_type').value;
            const sourceType = document.getElementById('source_type').value;

            // Add loading state
            const submitButton = form.querySelector('.btn-primary');
            const originalText = submitButton.textContent;
            submitButton.textContent = 'Updating...';

            // NEW: Collect subtitle URLs
            let englishSubtitles = [];
            let sinhalaSubtitles = [];
            
            // Collect quality-specific English subtitles
            const english720p = parseSubtitleUrls(document.getElementById('english_subtitles_720p').value);
            const english1080p = parseSubtitleUrls(document.getElementById('english_subtitles_1080p').value);
            const english2160p = parseSubtitleUrls(document.getElementById('english_subtitles_2160p').value);
            const englishAll = parseSubtitleUrls(document.getElementById('english_subtitles_all').value);
            
            // Collect quality-specific Sinhala subtitles
            const sinhala720p = parseSubtitleUrls(document.getElementById('sinhala_subtitles_720p').value);
            const sinhala1080p = parseSubtitleUrls(document.getElementById('sinhala_subtitles_1080p').value);
            const sinhala2160p = parseSubtitleUrls(document.getElementById('sinhala_subtitles_2160p').value);
            const sinhalaAll = parseSubtitleUrls(document.getElementById('sinhala_subtitles_all').value);
            
            // Combine subtitles: quality-specific first, then general
            englishSubtitles = [...new Set([...english720p, ...english1080p, ...english2160p, ...englishAll])];
            sinhalaSubtitles = [...new Set([...sinhala720p, ...sinhala1080p, ...sinhala2160p, ...sinhalaAll])];

            // Build data object
            const data = {
                type: mediaType,
                title: form.title.value.trim(),
                description: form.description.value.trim() || null,
                thumbnail: form.thumbnail.value.trim() || null,
                backdrop: form.backdrop.value.trim() || null,
                release_date: form.release_date.value || null,
                language: form.language.value.trim() || null,
                rating: form.rating.value ? parseFloat(form.rating.value) : null,
                source_type: sourceType,
                file_type: fileType,
                youtube_trailer: document.getElementById('youtube_trailer').value.trim() || null,
                genres: form.genres.value.trim() ? form.genres.value.split(',').map(g => g.trim()) : [],
                cast_members: JSON.parse(form.cast_members.value || '[]'),
                // NEW: Subtitles data
                subtitles: {
                    english: englishSubtitles,
                    sinhala: sinhalaSubtitles
                }
            };

            // NEW: Add status field for TV series
            if (mediaType === 'tv') {
                data.status = document.getElementById('status').value.trim() || null;
            }

            // NEW: Collect screenshot URLs
            const screenshots_720p = [];
            const screenshots_1080p = [];
            const screenshots_2160p = [];
            const screenshots_trailer = [];

            // Collect 720p screenshots
            const ss720p1 = document.getElementById('screenshots_720p_1').value.trim();
            const ss720p2 = document.getElementById('screenshots_720p_2').value.trim();
            if (ss720p1) screenshots_720p.push(ss720p1);
            if (ss720p2) screenshots_720p.push(ss720p2);
            
            // Collect 1080p screenshots
            const ss1080p1 = document.getElementById('screenshots_1080p_1').value.trim();
            const ss1080p2 = document.getElementById('screenshots_1080p_2').value.trim();
            if (ss1080p1) screenshots_1080p.push(ss1080p1);
            if (ss1080p2) screenshots_1080p.push(ss1080p2);
            
            // Collect 2160p screenshots
            const ss2160p1 = document.getElementById('screenshots_2160p_1').value.trim();
            const ss2160p2 = document.getElementById('screenshots_2160p_2').value.trim();
            if (ss2160p1) screenshots_2160p.push(ss2160p1);
            if (ss2160p2) screenshots_2160p.push(ss2160p2);
            
            // Collect trailer screenshots (optional)
            const ssTrailer1 = document.getElementById('screenshots_trailer_1').value.trim();
            const ssTrailer2 = document.getElementById('screenshots_trailer_2').value.trim();
            if (ssTrailer1) screenshots_trailer.push(ssTrailer1);
            if (ssTrailer2) screenshots_trailer.push(ssTrailer2);

            // Add screenshots to data
            data.screenshots_720p = screenshots_720p;
            data.screenshots_1080p = screenshots_1080p;
            data.screenshots_2160p = screenshots_2160p;
            data.screenshots_trailer = screenshots_trailer;

            if (mediaType === 'movie') {
                // Video links as direct URLs
                const v720Val = document.getElementById('video_720p').value.trim();
                const v1080Val = document.getElementById('video_1080p').value.trim();
                const v2160Val = document.getElementById('video_2160p').value.trim();
                
                data.video_720p = v720Val || null;
                data.video_1080p = v1080Val || null;
                data.video_2160p = v2160Val || null;
                
                // Download links as NESTED OBJECTS (matches your database)
                const dl720Val = document.getElementById('download_720p').value.trim();
                const dl1080Val = document.getElementById('download_1080p').value.trim();
                const dl2160Val = document.getElementById('download_2160p').value.trim();
                
                data.download_720p = dl720Val || null;
                data.download_1080p = dl1080Val || null;
                data.download_2160p = dl2160Val || null;
                
                // Telegram download links as direct URLs
                const tg720Val = document.getElementById('telegram_720p').value.trim();
                const tg1080Val = document.getElementById('telegram_1080p').value.trim();
                const tg2160Val = document.getElementById('telegram_2160p').value.trim();
                
                data.telegram_720p = tg720Val || null;
                data.telegram_1080p = tg1080Val || null;
                data.telegram_2160p = tg2160Val || null;
                
                // Torrent links as direct URLs
                const t720Val = document.getElementById('torrent_720p').value.trim();
                const t1080Val = document.getElementById('torrent_1080p').value.trim();
                const t2160Val = document.getElementById('torrent_2160p').value.trim();
                
                data.torrent_720p = t720Val || null;
                data.torrent_1080p = t1080Val || null;
                data.torrent_2160p = t2160Val || null;
            } else if (mediaType === 'tv') {
                // Get TV series video links
                const tv720 = document.getElementById('tv_video_720p') ? document.getElementById('tv_video_720p').value.trim() : null;
                const tv1080 = document.getElementById('tv_video_1080p') ? document.getElementById('tv_video_1080p').value.trim() : null;
                const tv2160 = document.getElementById('tv_video_2160p') ? document.getElementById('tv_video_2160p').value.trim() : null;
                
                data.video_720p = tv720 || null;
                data.video_1080p = tv1080 || null;
                data.video_2160p = tv2160 || null;

                // Get TV series Telegram links
                const tvTg720 = document.getElementById('tv_telegram_720p') ? document.getElementById('tv_telegram_720p').value.trim() : null;
                const tvTg1080 = document.getElementById('tv_telegram_1080p') ? document.getElementById('tv_telegram_1080p').value.trim() : null;
                const tvTg2160 = document.getElementById('tv_telegram_2160p') ? document.getElementById('tv_telegram_2160p').value.trim() : null;
                
                data.telegram_720p = tvTg720 || null;
                data.telegram_1080p = tvTg1080 || null;
                data.telegram_2160p = tvTg2160 || null;

                // Get TV series download links
                const tvDl720 = document.getElementById('tv_download_720p') ? document.getElementById('tv_download_720p').value.trim() : null;
                const tvDl1080 = document.getElementById('tv_download_1080p') ? document.getElementById('tv_download_1080p').value.trim() : null;
                const tvDl2160 = document.getElementById('tv_download_2160p') ? document.getElementById('tv_download_2160p').value.trim() : null;
                
                data.download_720p = tvDl720 || null;
                data.download_1080p = tvDl1080 || null;
                data.download_2160p = tvDl2160 || null;

                // Get TV series torrent links
                const tvTr720 = document.getElementById('tv_torrent_720p') ? document.getElementById('tv_torrent_720p').value.trim() : null;
                const tvTr1080 = document.getElementById('tv_torrent_1080p') ? document.getElementById('tv_torrent_1080p').value.trim() : null;
                const tvTr2160 = document.getElementById('tv_torrent_2160p') ? document.getElementById('tv_torrent_2160p').value.trim() : null;
                
                data.torrent_720p = tvTr720 || null;
                data.torrent_1080p = tvTr1080 || null;
                data.torrent_2160p = tvTr2160 || null;

                // Process seasons and episodes
                const seasons = {};
                const seasonContainers = document.querySelectorAll('.season-container');
                
                seasonContainers.forEach((seasonDiv, index) => {
                    const seasonNumber = index + 1;
                    const episodes = [];
                    const episodeRows = seasonDiv.querySelectorAll('.episode-row');
                    
                    episodeRows.forEach((row, epIndex) => {
                        const episodeNumber = epIndex + 1;
                        const episodeName = row.querySelector(`input[placeholder="Episode Name"]`).value.trim();
                        
                        if (episodeName) {
                            const dl720Val = row.querySelector(`input[placeholder="720p Download Link"]`).value.trim();
                            const dl1080Val = row.querySelector(`input[placeholder="1080p Download Link"]`).value.trim();
                            const dl2160Val = row.querySelector(`input[placeholder="2160p Download Link"]`).value.trim();
                            
                            // NEW: Parse episode subtitles
                            const episodeEnglishSubtitles = parseSubtitleUrls(row.querySelector(`input[placeholder="English Subtitles (comma-separated)"]`).value.trim());
                            const episodeSinhalaSubtitles = parseSubtitleUrls(row.querySelector(`input[placeholder="Sinhala Subtitles (comma-separated)"]`).value.trim());
                            
                            episodes.push({
                                episode_number: episodeNumber,
                                episode_name: episodeName,
                                video_720p: row.querySelector(`input[placeholder="720p Video Link"]`).value.trim() || null,
                                download_720p: dl720Val ? { url: dl720Val, file_type: fileType } : null,
                                telegram_720p: row.querySelector(`input[placeholder="720p Telegram Link"]`).value.trim() || null,
                                torrent_720p: row.querySelector(`input[placeholder="720p Torrent Link"]`).value.trim() || null,
                                video_1080p: row.querySelector(`input[placeholder="1080p Video Link"]`).value.trim() || null,
                                download_1080p: dl1080Val ? { url: dl1080Val, file_type: fileType } : null,
                                telegram_1080p: row.querySelector(`input[placeholder="1080p Telegram Link"]`).value.trim() || null,
                                torrent_1080p: row.querySelector(`input[placeholder="1080p Torrent Link"]`).value.trim() || null,
                                video_2160p: row.querySelector(`input[placeholder="2160p Video Link"]`).value.trim() || null,
                                download_2160p: dl2160Val ? { url: dl2160Val, file_type: fileType } : null,
                                telegram_2160p: row.querySelector(`input[placeholder="2160p Telegram Link"]`).value.trim() || null,
                                torrent_2160p: row.querySelector(`input[placeholder="2160p Torrent Link"]`).value.trim() || null,
                                // NEW: Episode subtitles
                                subtitles: {
                                    english: episodeEnglishSubtitles,
                                    sinhala: episodeSinhalaSubtitles
                                }
                            });
                        }
                    });

                    if (episodes.length > 0) {
                        seasons[`season_${seasonNumber}`] = {
                            season_number: seasonNumber,
                            total_episodes: episodes.length,
                            episodes: episodes
                        };
                    }
                });

                data.total_seasons = Object.keys(seasons).length;
                data.seasons = Object.keys(seasons).length > 0 ? seasons : null;
            }

            console.log('Sending data:', data);

            try {
                const response = await fetch(`${ADMIN_API_BASE_URL}/media/${mediaId}`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'Authorization': AUTH_HEADER 
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                console.log('Server response:', result);

                if (response.ok) {
                    const successMsg = document.getElementById('success-message');
                    successMsg.style.display = 'block';
                    successMsg.textContent = '‚úÖ Media updated successfully!';
                    
                    setTimeout(() => {
                        window.location.href = '/admin/search_and_edit';
                    }, 2000);
                } else {
                    alert(`Error: ${result.message || 'Unknown error'}`);
                }
            } catch (err) {
                console.error('Request failed:', err);
                alert('Network error: Unable to connect to server.');
            } finally {
                submitButton.textContent = originalText;
            }
        });

        // Initialize sections as expanded
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                const sections = ['subtitles-content', 'screenshots-content'];
                sections.forEach(sectionId => {
                    const section = document.getElementById(sectionId);
                    if (section) {
                        section.classList.remove('collapsed');
                        const toggle = section.previousElementSibling;
                        if (toggle) {
                            toggle.classList.remove('collapsed');
                        }
                    }
                });
            }, 100);
        });
    </script>
</body>
</html>
